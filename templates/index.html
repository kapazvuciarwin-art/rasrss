<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rasrss ï¼ RSS æ—¥æ–‡é€å­—ç¨¿</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "Segoe UI", "Noto Sans TC", sans-serif;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 24px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-weight: 700;
            color: #eee;
        }
        .card {
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card h2 {
            margin-bottom: 16px;
            font-size: 1.1rem;
            color: #aaccff;
        }
        .form-group {
            margin-bottom: 14px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #bbb;
            font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            color: #fff;
            font-size: 1rem;
        }
        .form-group input::placeholder {
            color: #888;
        }
        .form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 200px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: #fff;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary { background: #495057; color: #fff; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        .feeds-list { list-style: none; }
        .feeds-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .feeds-list li:last-child { border-bottom: none; }
        .feed-title { font-weight: 600; color: #ccc; }
        .feed-meta { font-size: 0.85rem; color: #888; }
        .transcript-list { list-style: none; }
        .transcript-list li {
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .transcript-list li:last-child { border-bottom: none; }
        .transcript-title { font-weight: 600; margin-bottom: 4px; color: #ddd; }
        .transcript-date { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .transcript-preview {
            font-size: 0.9rem;
            color: #aaa;
            max-height: 4em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .transcript-full {
            white-space: pre-wrap;
            line-height: 1.7;
            padding: 20px;
            background: rgba(0,0,0,0.25);
            border-radius: 8px;
            margin-top: 12px;
            color: #e0e0e0;
        }
        .msg { padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .msg.error { background: rgba(220,53,69,0.2); color: #f8a0a0; }
        .msg.success { background: rgba(40,167,69,0.2); color: #90ee90; }
        .msg.info { background: rgba(0,120,255,0.15); color: #aaccff; }
        .github-hint {
            margin-top: 16px;
            font-size: 0.9rem;
            color: #888;
        }
        .github-hint a { color: #6ea8fe; }
        .provider-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .provider-option:hover { border-color: rgba(170,204,255,0.5); }
        .provider-option input { margin-top: 3px; }
        .provider-option.selected { border-color: #aaccff; background: rgba(68,102,238,0.15); }
        .provider-label strong { display: block; color: #ddd; }
        .provider-label small { color: #888; font-size: 0.85rem; }
        .api-settings-row { margin-top: 14px; }
        .api-status-msg { margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“» rasrss ï¼ RSS æ—¥æ–‡é€å­—ç¨¿</h1>
        <p style="text-align: center; color: #888; margin-bottom: 24px;">
            è¼¸å…¥ RSS é€£çµä¸¦é¸æ“‡é€±æœŸï¼Œç³»çµ±æœƒå®šæœŸå–å¾—æœ€æ–° MP3 é€£çµä¸¦å‚³çµ¦ AI API ç”¢ç”Ÿæ—¥æ–‡é€å­—ç¨¿ï¼ˆä¸€å­—ä¸æ¼ã€ä¸æ‘˜è¦ï¼‰ï¼Œä¸ä¸‹è¼‰ MP3ã€‚é€å­—ç¨¿é¡¯ç¤ºæ–¼æ­¤èˆ‡ GitHub Pagesã€‚
        </p>

        <div class="card">
            <h2>ğŸ”‘ AI API è¨­å®š</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 14px;">
                é¸æ“‡ AI æä¾›è€…ä¸¦è¼¸å…¥ API Key å¾Œå„²å­˜ã€‚<strong>æ—¥æ–‡é€å­—ç¨¿ä½¿ç”¨ AI Studioï¼ˆGeminiï¼‰</strong>ï¼Œè«‹å‹™å¿…å¡«å¯« Gemini API Keyã€‚Gemini å„ªå…ˆ 3.0 Flash ç›¸é—œ â†’ 2.5 â†’ 2.0ï¼›OpenRouter è‡ªå‹•é¸å…è²»ä¸­æœ€å¥½çš„æ¨¡å‹ã€‚
            </p>
            <div class="form-group">
                <label>é¸æ“‡ API æä¾›è€…</label>
                <label class="provider-option" id="provider-option-gemini">
                    <input type="radio" name="api_provider" value="gemini">
                    <span class="provider-label">
                        <strong>AI Studioï¼ˆGeminiï¼‰</strong>
                        <small>å„ªå…ˆ 3.0 Flash ç›¸é—œ â†’ 2.5 â†’ 2.0</small>
                    </span>
                </label>
                <label class="provider-option" id="provider-option-openrouter">
                    <input type="radio" name="api_provider" value="openrouter">
                    <span class="provider-label">
                        <strong>OpenRouter</strong>
                        <small>è‡ªå‹•é¸å…è²»ä¸­æœ€å¥½çš„æ¨¡å‹</small>
                    </span>
                </label>
            </div>
            <div id="api-key-area-gemini" class="api-settings-row">
                <div class="form-group">
                    <label>Gemini API Key</label>
                    <input type="password" id="gemini_api_key" placeholder="AI Studio å–å¾—ï¼šhttps://aistudio.google.com/apikey">
                </div>
            </div>
            <div id="api-key-area-openrouter" class="api-settings-row" style="display: none;">
                <div class="form-group">
                    <label>OpenRouter API Key</label>
                    <input type="password" id="openrouter_api_key" placeholder="https://openrouter.ai/keys">
                </div>
            </div>
            <div class="form-row" style="margin-top: 14px;">
                <button type="button" class="btn btn-primary" onclick="saveApiSettings()">å„²å­˜ API è¨­å®š</button>
                <button type="button" class="btn btn-secondary" onclick="testApiConnection()">æ¸¬è©¦é€£ç·š</button>
            </div>
            <div id="api-settings-msg" class="api-status-msg"></div>
        </div>

        <div class="card">
            <h2>æ–°å¢ RSS è¨‚é–±</h2>
            <div id="add-msg"></div>
            <form id="add-feed-form">
                <div class="form-group">
                    <label>RSS é€£çµï¼ˆéœ€åŒ…å« MP3 çš„ç¯€ç›®ï¼‰</label>
                    <input type="url" id="rss_url" placeholder="https://example.com/feed.xml" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¢ç”Ÿé€å­—ç¨¿é€±æœŸ</label>
                        <select id="schedule">
                            {% for key, minutes, label in schedule_options %}
                            <option value="{{ key }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" style="flex: 0;">
                        <button type="submit" class="btn btn-primary">æ–°å¢è¨‚é–±</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>æˆ‘çš„ RSS è¨‚é–±</h2>
            <ul class="feeds-list" id="feeds-list"></ul>
        </div>

        <div class="card">
            <h2>é€å­—ç¨¿åˆ—è¡¨</h2>
            <div class="form-group">
                <label>ç¯©é¸è¨‚é–±ä¾†æº</label>
                <select id="filter-feed">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <ul class="transcript-list" id="transcript-list"></ul>
        </div>

        <div class="card" id="transcript-detail-card" style="display: none;">
            <h2 id="transcript-detail-title"></h2>
            <p id="transcript-detail-date" class="transcript-date"></p>
            <div id="transcript-detail-body" class="transcript-full"></div>
            <p class="github-hint">
                é€å­—ç¨¿æœƒåŒæ­¥å¯«å…¥æœ¬å°ˆæ¡ˆ <code>docs/transcripts/</code> ä¸¦ push åˆ° GitHubï¼›è‹¥å·²å•Ÿç”¨ GitHub Pagesï¼ˆä¾†æºï¼šmain / docsï¼‰ï¼Œå¯æ–¼ç«™ä¸ŠæŸ¥çœ‹ã€‚
            </p>
        </div>
    </div>

    <script>
        const filterFeed = document.getElementById('filter-feed');
        const feedsList = document.getElementById('feeds-list');
        const transcriptList = document.getElementById('transcript-list');
        const addMsg = document.getElementById('add-msg');
        const detailCard = document.getElementById('transcript-detail-card');
        const detailTitle = document.getElementById('transcript-detail-title');
        const detailDate = document.getElementById('transcript-detail-date');
        const detailBody = document.getElementById('transcript-detail-body');

        function getApiProvider() { return document.querySelector('input[name="api_provider"]:checked')?.value || 'gemini'; }
        function setApiProviderUI() {
            const p = getApiProvider();
            document.getElementById('api-key-area-gemini').style.display = p === 'gemini' ? 'block' : 'none';
            document.getElementById('api-key-area-openrouter').style.display = p === 'openrouter' ? 'block' : 'none';
            document.getElementById('provider-option-gemini').classList.toggle('selected', p === 'gemini');
            document.getElementById('provider-option-openrouter').classList.toggle('selected', p === 'openrouter');
        }
        document.querySelectorAll('input[name="api_provider"]').forEach(el => el.addEventListener('change', setApiProviderUI));

        async function loadApiSettings() {
            try {
                const r = await fetch('/api/settings');
                const d = await r.json();
                document.querySelector('input[name="api_provider"][value="' + (d.api_provider || 'gemini') + '"]').checked = true;
                setApiProviderUI();
                if (d.has_gemini_key) document.getElementById('gemini_api_key').placeholder = 'ï¼ˆå·²å„²å­˜ï¼‰å¯ç•™ç©ºæˆ–é‡æ–°è¼¸å…¥è¦†è“‹';
                if (d.has_openrouter_key) document.getElementById('openrouter_api_key').placeholder = 'ï¼ˆå·²å„²å­˜ï¼‰å¯ç•™ç©ºæˆ–é‡æ–°è¼¸å…¥è¦†è“‹';
            } catch (e) { console.warn('loadApiSettings', e); }
        }
        async function saveApiSettings() {
            const msgEl = document.getElementById('api-settings-msg');
            const provider = getApiProvider();
            const body = {
                api_provider: provider,
                gemini_api_key: document.getElementById('gemini_api_key').value.trim(),
                openrouter_api_key: document.getElementById('openrouter_api_key').value.trim()
            };
            if (!body.gemini_api_key && !body.openrouter_api_key) { msgEl.innerHTML = '<span class="msg error">è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ API Keyï¼ˆç”¢ç”Ÿæ—¥æ–‡é€å­—ç¨¿éœ€ Geminiï¼‰</span>'; return; }
            try {
                const r = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const d = await r.json();
                if (r.ok && d.success) { msgEl.innerHTML = '<span class="msg success">å·²å„²å­˜</span>'; loadApiSettings(); }
                else msgEl.innerHTML = '<span class="msg error">' + (d.error || 'å„²å­˜å¤±æ•—') + '</span>';
            } catch (e) { msgEl.innerHTML = '<span class="msg error">' + e.message + '</span>'; }
        }
        async function testApiConnection() {
            const msgEl = document.getElementById('api-settings-msg');
            const provider = getApiProvider();
            const body = {
                api_provider: provider,
                gemini_api_key: document.getElementById('gemini_api_key').value.trim(),
                openrouter_api_key: document.getElementById('openrouter_api_key').value.trim()
            };
            if (provider === 'gemini' && !body.gemini_api_key) { msgEl.innerHTML = '<span class="msg error">è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ Gemini API Key</span>'; return; }
            if (provider === 'openrouter' && !body.openrouter_api_key) { msgEl.innerHTML = '<span class="msg error">è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ OpenRouter API Key</span>'; return; }
            msgEl.innerHTML = '<span class="msg info">æ¸¬è©¦ä¸­â€¦</span>';
            try {
                const r = await fetch('/api/ai-test', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const d = await r.json();
                if (r.ok && d.success) msgEl.innerHTML = '<span class="msg success">é€£ç·šæˆåŠŸï¼ˆ' + (d.model || '') + 'ï¼‰</span>';
                else msgEl.innerHTML = '<span class="msg error">' + (d.error || 'é€£ç·šå¤±æ•—') + '</span>';
            } catch (e) { msgEl.innerHTML = '<span class="msg error">' + e.message + '</span>'; }
        }

        function showAddMsg(text, type) {
            addMsg.innerHTML = '<div class="msg ' + type + '">' + text + '</div>';
            setTimeout(() => { addMsg.innerHTML = ''; }, 5000);
        }

        async function loadFeeds() {
            const res = await fetch('/api/feeds');
            const feeds = await res.json();
            filterFeed.innerHTML = '<option value="">å…¨éƒ¨</option>' + feeds.map(f => 
                '<option value="' + f.id + '">' + (f.title || f.rss_url) + '</option>'
            ).join('');
            feedsList.innerHTML = feeds.length === 0 
                ? '<li class="feed-meta">å°šç„¡è¨‚é–±ï¼Œè«‹åœ¨ä¸Šæ–¹æ–°å¢ RSSã€‚</li>' 
                : feeds.map(f => {
                    const scheduleLabel = { hourly: 'æ¯å°æ™‚', '6hours': 'æ¯6å°æ™‚', daily: 'æ¯æ—¥', weekly: 'æ¯é€±' };
                    const key = Object.entries({ 60: 'hourly', 360: '6hours', 1440: 'daily', 10080: 'weekly' }).find(([m]) => parseInt(m) === f.schedule_minutes)?.[1] || 'daily';
                    const errHtml = f.last_error ? '<br><span class="msg error" style="display:inline-block;margin-top:6px;font-size:0.85rem;">è½‰éŒ„å¤±æ•—: ' + (f.last_error || '').slice(0, 120) + '</span>' : '';
                    return '<li>' +
                        '<div><span class="feed-title">' + (f.title || f.rss_url) + '</span><br><span class="feed-meta">' + (scheduleLabel[key] || 'æ¯æ—¥') + ' Â· ä¸Šæ¬¡åŸ·è¡Œ: ' + (f.last_run_at || 'å°šæœª') + '</span>' + errHtml + '</div>' +
                        '<div><button class="btn btn-success btn-small" onclick="runNow(' + f.id + ')">ç«‹å³åŸ·è¡Œ</button> <button class="btn btn-danger btn-small" onclick="deleteFeed(' + f.id + ')">åˆªé™¤</button></div>' +
                        '</li>';
                }).join('');
        }

        async function loadTranscripts() {
            const feedId = filterFeed.value || '';
            const url = feedId ? '/api/transcripts?feed_id=' + feedId : '/api/transcripts';
            const res = await fetch(url);
            const list = await res.json();
            transcriptList.innerHTML = list.length === 0 
                ? '<li class="transcript-date">å°šç„¡é€å­—ç¨¿ã€‚</li>' 
                : list.map(t => {
                    const preview = (t.transcript_text || '').slice(0, 120) + ((t.transcript_text || '').length > 120 ? 'â€¦' : '');
                    return '<li>' +
                        '<div class="transcript-title">' + (t.episode_title || 'Episode') + '</div>' +
                        '<div class="transcript-date">' + t.created_at + '</div>' +
                        '<div class="transcript-preview">' + preview + '</div>' +
                        '<button class="btn btn-secondary btn-small" style="margin-top:8px" onclick="viewTranscript(' + t.id + ')">æŸ¥çœ‹å®Œæ•´é€å­—ç¨¿</button>' +
                        '</li>';
                }).join('');
        }

        async function viewTranscript(id) {
            const res = await fetch('/api/transcripts/' + id);
            const t = await res.json();
            detailTitle.textContent = t.episode_title || 'é€å­—ç¨¿';
            detailDate.textContent = t.created_at;
            detailBody.textContent = t.transcript_text || '';
            detailCard.style.display = 'block';
            detailCard.scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteFeed(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚é–±ï¼Ÿ')) return;
            await fetch('/api/feeds/' + id, { method: 'DELETE' });
            loadFeeds();
            loadTranscripts();
        }

        async function runNow(id) {
            await fetch('/api/run-now/' + id, { method: 'POST' });
            showAddMsg('å·²æ’å…¥åŸ·è¡Œï¼Œè«‹ç¨å€™é‡æ–°æ•´ç†é€å­—ç¨¿åˆ—è¡¨ã€‚', 'info');
            setTimeout(loadTranscripts, 15000);
        }

        document.getElementById('add-feed-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rss_url = document.getElementById('rss_url').value.trim();
            const schedule = document.getElementById('schedule').value;
            const res = await fetch('/api/feeds', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rss_url, schedule })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                showAddMsg('å·²æ–°å¢è¨‚é–±ã€‚ç³»çµ±æœƒä¾é€±æœŸå°‡æœ€æ–° MP3 é€£çµå‚³çµ¦ AI API ç”¢ç”Ÿæ—¥æ–‡é€å­—ç¨¿ã€‚', 'success');
                document.getElementById('rss_url').value = '';
                loadFeeds();
            } else {
                showAddMsg(data.error || 'æ–°å¢å¤±æ•—', 'error');
            }
        });

        filterFeed.addEventListener('change', loadTranscripts);

        document.addEventListener('DOMContentLoaded', () => {
            setApiProviderUI();
            loadApiSettings();
            loadFeeds();
            loadTranscripts();
        });
    </script>
</body>
</html>

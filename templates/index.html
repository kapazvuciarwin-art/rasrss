<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rasrss ï¼ RSS æ—¥æ–‡é€å­—ç¨¿</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "Segoe UI", "Noto Sans TC", sans-serif;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 24px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-weight: 700;
            color: #eee;
        }
        .card {
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card h2 {
            margin-bottom: 16px;
            font-size: 1.1rem;
            color: #aaccff;
        }
        .form-group {
            margin-bottom: 14px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #bbb;
            font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            color: #fff;
            font-size: 1rem;
        }
        .form-group input::placeholder {
            color: #888;
        }
        .form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 200px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: #fff;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary { background: #495057; color: #fff; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        .feeds-list { list-style: none; }
        .feeds-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .feeds-list li:last-child { border-bottom: none; }
        .feed-title { font-weight: 600; color: #ccc; }
        .feed-meta { font-size: 0.85rem; color: #888; }
        .transcript-list { list-style: none; }
        .transcript-list li {
            padding: 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .transcript-list li:last-child { border-bottom: none; }
        .transcript-row-btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            text-align: left;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: #ddd;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
        }
        .transcript-row-btn:hover {
            background: rgba(255,255,255,0.08);
            color: #fff;
        }
        .transcript-date { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .transcript-full {
            white-space: pre-wrap;
            line-height: 1.7;
            padding: 20px;
            background: rgba(0,0,0,0.25);
            border-radius: 8px;
            margin-top: 12px;
            color: #e0e0e0;
        }
        .msg { padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .msg.error { background: rgba(220,53,69,0.2); color: #f8a0a0; }
        .msg.success { background: rgba(40,167,69,0.2); color: #90ee90; }
        .msg.info { background: rgba(0,120,255,0.15); color: #aaccff; }
        .github-hint {
            margin-top: 16px;
            font-size: 0.9rem;
            color: #888;
        }
        .github-hint a { color: #6ea8fe; }
        .provider-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .provider-option:hover { border-color: rgba(170,204,255,0.5); }
        .provider-option input { margin-top: 3px; }
        .provider-option.selected { border-color: #aaccff; background: rgba(68,102,238,0.15); }
        .provider-label strong { display: block; color: #ddd; }
        .provider-label small { color: #888; font-size: 0.85rem; }
        .api-settings-row { margin-top: 14px; }
        .api-status-msg { margin-top: 10px; font-size: 0.9rem; }
        .furigana-pop {
            position: fixed;
            z-index: 9999;
            display: none;
            max-width: min(420px, 85vw);
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(10, 12, 18, 0.92);
            border: 1px solid rgba(255,255,255,0.14);
            color: #eaeaea;
            font-size: 0.95rem;
            line-height: 1.2;
            box-shadow: 0 12px 30px rgba(0,0,0,0.35);
            backdrop-filter: blur(6px);
        }
        .furigana-pop .w { color: #bcd7ff; font-weight: 700; }
        .furigana-pop .r { color: #eaeaea; }
        .furigana-extend-btn {
            margin-left: 6px; padding: 2px 6px; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px; background: rgba(255,255,255,0.1); color: #eaeaea;
            font-size: 0.9rem; cursor: pointer;
        }
        .furigana-extend-btn:hover { background: rgba(255,255,255,0.2); }
        .furigana-extend-results { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; color: #aaa; }
        .furigana-extend-results .item { margin: 4px 0; cursor: pointer; padding: 4px 6px; border-radius: 4px; }
        .furigana-extend-results .item:hover { background: rgba(255,255,255,0.1); color: #eaeaea; }
        .transcript-audio-wrap {
            margin: 12px 0;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: #1a1a2e;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .audio-controls .btn { flex-shrink: 0; }
        .audio-time {
            font-size: 0.9rem;
            color: #aaa;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“» rasrss ï¼ RSS æ—¥æ–‡é€å­—ç¨¿</h1>
        <p style="text-align: center; color: #888; margin-bottom: 24px;">
            è¼¸å…¥ RSS é€£çµä¸¦é¸æ“‡é€±æœŸï¼Œç³»çµ±æœƒå®šæœŸå–å¾—æœ€æ–° MP3 é€£çµä¸¦å‚³çµ¦ AI API ç”¢ç”Ÿæ—¥æ–‡é€å­—ç¨¿ï¼ˆä¸€å­—ä¸æ¼ã€ä¸æ‘˜è¦ï¼‰ï¼Œä¸ä¸‹è¼‰ MP3ã€‚é€å­—ç¨¿é¡¯ç¤ºæ–¼æ­¤èˆ‡ GitHub Pagesã€‚
        </p>

        <div class="card">
            <h2>ğŸ”‘ AI API è¨­å®š</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 14px;">
                é¸æ“‡ AI æä¾›è€…ä¸¦è¼¸å…¥ API Key å¾Œå„²å­˜ã€‚<strong>æ—¥æ–‡é€å­—ç¨¿ä½¿ç”¨ AI Studioï¼ˆGeminiï¼‰</strong>ï¼Œè«‹å‹™å¿…å¡«å¯« Gemini API Keyã€‚Gemini å„ªå…ˆ 3.0 Flash ç›¸é—œ â†’ 2.5 â†’ 2.0ï¼›OpenRouter è‡ªå‹•é¸å…è²»ä¸­æœ€å¥½çš„æ¨¡å‹ã€‚
            </p>
            <div class="form-group">
                <label>é¸æ“‡ API æä¾›è€…</label>
                <label class="provider-option" id="provider-option-gemini">
                    <input type="radio" name="api_provider" value="gemini">
                    <span class="provider-label">
                        <strong>AI Studioï¼ˆGeminiï¼‰</strong>
                        <small>å„ªå…ˆ 3.0 Flash ç›¸é—œ â†’ 2.5 â†’ 2.0</small>
                    </span>
                </label>
                <label class="provider-option" id="provider-option-openrouter">
                    <input type="radio" name="api_provider" value="openrouter">
                    <span class="provider-label">
                        <strong>OpenRouter</strong>
                        <small>è‡ªå‹•é¸å…è²»ä¸­æœ€å¥½çš„æ¨¡å‹</small>
                    </span>
                </label>
            </div>
            <div id="api-key-area-gemini" class="api-settings-row">
                <div class="form-group">
                    <label>Gemini API Key</label>
                    <input type="password" id="gemini_api_key" placeholder="AI Studio å–å¾—ï¼šhttps://aistudio.google.com/apikey">
                </div>
            </div>
            <div id="api-key-area-openrouter" class="api-settings-row" style="display: none;">
                <div class="form-group">
                    <label>OpenRouter API Key</label>
                    <input type="password" id="openrouter_api_key" placeholder="https://openrouter.ai/keys">
                </div>
            </div>
            <div class="form-row" style="margin-top: 14px;">
                <button type="button" class="btn btn-primary" onclick="saveApiSettings()">å„²å­˜ API è¨­å®š</button>
                <button type="button" class="btn btn-secondary" onclick="testApiConnection()">æ¸¬è©¦é€£ç·š</button>
            </div>
            <div id="api-settings-msg" class="api-status-msg"></div>
        </div>

        <div class="card">
            <h2>æ–°å¢ RSS è¨‚é–±</h2>
            <div id="add-msg"></div>
            <form id="add-feed-form">
                <div class="form-group">
                    <label>RSS é€£çµï¼ˆéœ€åŒ…å« MP3 çš„ç¯€ç›®ï¼‰</label>
                    <input type="url" id="rss_url" placeholder="https://example.com/feed.xml" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¢ç”Ÿé€å­—ç¨¿é€±æœŸ</label>
                        <select id="schedule">
                            {% for key, minutes, label in schedule_options %}
                            <option value="{{ key }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" style="flex: 0;">
                        <button type="submit" class="btn btn-primary">æ–°å¢è¨‚é–±</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>æˆ‘çš„ RSS è¨‚é–±</h2>
            <ul class="feeds-list" id="feeds-list"></ul>
        </div>

        <div class="card">
            <h2>é€å­—ç¨¿åˆ—è¡¨</h2>
            <div class="form-group">
                <label>ç¯©é¸è¨‚é–±ä¾†æº</label>
                <select id="filter-feed">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div id="transcript-list-day-nav" style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary btn-small" id="transcript-prev-day" title="å‰ä¸€å¤©">â† å‰ä¸€å¤©</button>
                <span id="transcript-list-day-label" style="font-weight: 600; color: #ccc; min-width: 80px;"></span>
                <button type="button" class="btn btn-secondary btn-small" id="transcript-next-day" title="å¾Œä¸€å¤©">å¾Œä¸€å¤© â†’</button>
            </div>
            <ul class="transcript-list" id="transcript-list"></ul>
        </div>

        <div class="card" id="transcript-detail-card" style="display: none;">
            <h2 id="transcript-detail-title"></h2>
            <p id="transcript-detail-date" class="transcript-date"></p>
            <div id="transcript-audio-wrap" class="transcript-audio-wrap" style="display: none;">
                <audio id="transcript-audio" preload="metadata"></audio>
                <div class="audio-controls">
                    <button type="button" class="btn btn-secondary btn-small" id="audio-back-10" title="å€’é€€ 10 ç§’">âª å€’é€€ 10 ç§’</button>
                    <button type="button" class="btn btn-secondary btn-small" id="audio-play-pause" title="æ’­æ”¾/æš«åœ">â–¶ æ’­æ”¾</button>
                    <button type="button" class="btn btn-secondary btn-small" id="audio-fwd-10" title="å‰é€² 10 ç§’">â© å‰é€² 10 ç§’</button>
                    <span id="audio-time" class="audio-time">0:00 / 0:00</span>
                </div>
            </div>
            <div id="transcript-detail-body" class="transcript-full"></div>
            <p class="github-hint">
                é€å­—ç¨¿æœƒåŒæ­¥å¯«å…¥æœ¬å°ˆæ¡ˆ <code>docs/transcripts/</code> ä¸¦ push åˆ° GitHubï¼›è‹¥å·²å•Ÿç”¨ GitHub Pagesï¼ˆä¾†æºï¼šmain / docsï¼‰ï¼Œå¯æ–¼ç«™ä¸ŠæŸ¥çœ‹ã€‚
            </p>
        </div>
    </div>

    <div id="furigana-pop" class="furigana-pop" role="status" aria-live="polite"></div>

    <script>
        const filterFeed = document.getElementById('filter-feed');
        const feedsList = document.getElementById('feeds-list');
        const transcriptList = document.getElementById('transcript-list');
        const addMsg = document.getElementById('add-msg');
        const detailCard = document.getElementById('transcript-detail-card');
        const detailTitle = document.getElementById('transcript-detail-title');
        const detailDate = document.getElementById('transcript-detail-date');
        const detailBody = document.getElementById('transcript-detail-body');
        const furiganaPop = document.getElementById('furigana-pop');
        let furiganaAbort = null;
        let currentWord = null;
        let currentReading = null;
        let currentContextText = '';
        let currentContextOffset = 0;

        function getApiProvider() { return document.querySelector('input[name="api_provider"]:checked')?.value || 'gemini'; }
        function setApiProviderUI() {
            const p = getApiProvider();
            document.getElementById('api-key-area-gemini').style.display = p === 'gemini' ? 'block' : 'none';
            document.getElementById('api-key-area-openrouter').style.display = p === 'openrouter' ? 'block' : 'none';
            document.getElementById('provider-option-gemini').classList.toggle('selected', p === 'gemini');
            document.getElementById('provider-option-openrouter').classList.toggle('selected', p === 'openrouter');
        }
        document.querySelectorAll('input[name="api_provider"]').forEach(el => el.addEventListener('change', setApiProviderUI));

        async function loadApiSettings() {
            try {
                const r = await fetch('/api/settings');
                const d = await r.json();
                document.querySelector('input[name="api_provider"][value="' + (d.api_provider || 'gemini') + '"]').checked = true;
                setApiProviderUI();
                if (d.has_gemini_key) document.getElementById('gemini_api_key').placeholder = 'ï¼ˆå·²å„²å­˜ï¼‰å¯ç•™ç©ºæˆ–é‡æ–°è¼¸å…¥è¦†è“‹';
                if (d.has_openrouter_key) document.getElementById('openrouter_api_key').placeholder = 'ï¼ˆå·²å„²å­˜ï¼‰å¯ç•™ç©ºæˆ–é‡æ–°è¼¸å…¥è¦†è“‹';
            } catch (e) { console.warn('loadApiSettings', e); }
        }
        async function saveApiSettings() {
            const msgEl = document.getElementById('api-settings-msg');
            const provider = getApiProvider();
            const body = {
                api_provider: provider,
                gemini_api_key: document.getElementById('gemini_api_key').value.trim(),
                openrouter_api_key: document.getElementById('openrouter_api_key').value.trim()
            };
            if (!body.gemini_api_key && !body.openrouter_api_key) { msgEl.innerHTML = '<span class="msg error">è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ API Keyï¼ˆç”¢ç”Ÿæ—¥æ–‡é€å­—ç¨¿éœ€ Geminiï¼‰</span>'; return; }
            try {
                const r = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const d = await r.json();
                if (r.ok && d.success) { msgEl.innerHTML = '<span class="msg success">å·²å„²å­˜</span>'; loadApiSettings(); }
                else msgEl.innerHTML = '<span class="msg error">' + (d.error || 'å„²å­˜å¤±æ•—') + '</span>';
            } catch (e) { msgEl.innerHTML = '<span class="msg error">' + e.message + '</span>'; }
        }
        async function testApiConnection() {
            const msgEl = document.getElementById('api-settings-msg');
            const provider = getApiProvider();
            const body = {
                api_provider: provider,
                gemini_api_key: document.getElementById('gemini_api_key').value.trim(),
                openrouter_api_key: document.getElementById('openrouter_api_key').value.trim()
            };
            if (provider === 'gemini' && !body.gemini_api_key) { msgEl.innerHTML = '<span class="msg error">è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ Gemini API Key</span>'; return; }
            if (provider === 'openrouter' && !body.openrouter_api_key) { msgEl.innerHTML = '<span class="msg error">è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ OpenRouter API Key</span>'; return; }
            msgEl.innerHTML = '<span class="msg info">æ¸¬è©¦ä¸­â€¦</span>';
            try {
                const r = await fetch('/api/ai-test', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const d = await r.json();
                if (r.ok && d.success) msgEl.innerHTML = '<span class="msg success">é€£ç·šæˆåŠŸï¼ˆ' + (d.model || '') + 'ï¼‰</span>';
                else msgEl.innerHTML = '<span class="msg error">' + (d.error || 'é€£ç·šå¤±æ•—') + '</span>';
            } catch (e) { msgEl.innerHTML = '<span class="msg error">' + e.message + '</span>'; }
        }

        function showAddMsg(text, type) {
            addMsg.innerHTML = '<div class="msg ' + type + '">' + text + '</div>';
            setTimeout(() => { addMsg.innerHTML = ''; }, 5000);
        }

        async function loadFeeds() {
            const res = await fetch('/api/feeds');
            const feeds = await res.json();
            filterFeed.innerHTML = '<option value="">å…¨éƒ¨</option>' + feeds.map(f => 
                '<option value="' + f.id + '">' + (f.title || f.rss_url) + '</option>'
            ).join('');
            feedsList.innerHTML = feeds.length === 0 
                ? '<li class="feed-meta">å°šç„¡è¨‚é–±ï¼Œè«‹åœ¨ä¸Šæ–¹æ–°å¢ RSSã€‚</li>' 
                : feeds.map(f => {
                    const scheduleLabel = { hourly: 'æ¯å°æ™‚', '6hours': 'æ¯6å°æ™‚', daily: 'æ¯æ—¥', weekly: 'æ¯é€±' };
                    const key = Object.entries({ 60: 'hourly', 360: '6hours', 1440: 'daily', 10080: 'weekly' }).find(([m]) => parseInt(m) === f.schedule_minutes)?.[1] || 'daily';
                    const errHtml = f.last_error ? '<br><span class="msg error" style="display:inline-block;margin-top:6px;font-size:0.85rem;">è½‰éŒ„å¤±æ•—: ' + (f.last_error || '').slice(0, 120) + '</span>' : '';
                    return '<li>' +
                        '<div><span class="feed-title">' + (f.title || f.rss_url) + '</span><br><span class="feed-meta">' + (scheduleLabel[key] || 'æ¯æ—¥') + ' Â· ä¸Šæ¬¡åŸ·è¡Œ: ' + (f.last_run_at || 'å°šæœª') + '</span>' + errHtml + '</div>' +
                        '<div><button class="btn btn-success btn-small" onclick="runNow(' + f.id + ')">ç«‹å³åŸ·è¡Œ</button> <button class="btn btn-danger btn-small" onclick="deleteFeed(' + f.id + ')">åˆªé™¤</button></div>' +
                        '</li>';
                }).join('');
        }

        function shortLabel(t) {
            const program = (t.episode_title || '').split('_')[0] || 'Episode';
            let dateStr = '';
            if (t.created_at) {
                const d = new Date(t.created_at);
                dateStr = (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + (d.getMinutes() < 10 ? '0' : '') + d.getMinutes();
            }
            return (program + ' ' + dateStr).trim();
        }
        function getDateKey(t) {
            if (!t.created_at) return '';
            const d = new Date(t.created_at);
            const y = d.getFullYear(), m = d.getMonth() + 1, day = d.getDate();
            return y + '-' + (m < 10 ? '0' : '') + m + '-' + (day < 10 ? '0' : '') + day;
        }
        function formatDayLabel(dateKey) {
            if (!dateKey) return '';
            const [y, m, d] = dateKey.split('-').map(Number);
            return m + 'æœˆ' + d + 'æ—¥';
        }
        function escapeHtml(s) {
            if (!s) return '';
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }
        let transcriptListData = [];
        let transcriptDates = [];
        let transcriptDayIndex = 0;
        const dayNavEl = document.getElementById('transcript-list-day-nav');
        const dayLabelEl = document.getElementById('transcript-list-day-label');
        const prevDayBtn = document.getElementById('transcript-prev-day');
        const nextDayBtn = document.getElementById('transcript-next-day');
        function renderTranscriptListForDay() {
            const list = transcriptListData;
            if (list.length === 0) {
                dayNavEl.style.display = 'none';
                transcriptList.innerHTML = '<li class="transcript-date">å°šç„¡é€å­—ç¨¿ã€‚</li>';
                return;
            }
            const dates = [...new Set(list.map(getDateKey))].filter(Boolean).sort().reverse();
            transcriptDates = dates;
            if (transcriptDayIndex >= dates.length) transcriptDayIndex = Math.max(0, dates.length - 1);
            if (transcriptDayIndex < 0) transcriptDayIndex = 0;
            const currentDate = dates[transcriptDayIndex] || dates[0];
            const itemsForDay = list.filter(t => getDateKey(t) === currentDate);
            dayNavEl.style.display = 'flex';
            dayLabelEl.textContent = formatDayLabel(currentDate);
            prevDayBtn.disabled = transcriptDayIndex >= dates.length - 1;
            nextDayBtn.disabled = transcriptDayIndex <= 0;
            transcriptList.innerHTML = itemsForDay.length === 0
                ? '<li class="transcript-date">ç•¶æ—¥å°šç„¡é€å­—ç¨¿ã€‚</li>'
                : itemsForDay.map(t => {
                    const label = escapeHtml(shortLabel(t));
                    return '<li><button type="button" class="transcript-row-btn" onclick="viewTranscript(' + t.id + ')">' + label + '</button></li>';
                }).join('');
        }
        async function loadTranscripts() {
            const feedId = filterFeed.value || '';
            const url = feedId ? '/api/transcripts?feed_id=' + feedId : '/api/transcripts';
            const res = await fetch(url);
            const list = await res.json();
            transcriptListData = list;
            transcriptDayIndex = 0;
            renderTranscriptListForDay();
        }
        prevDayBtn.addEventListener('click', function() {
            if (transcriptDates.length === 0) return;
            if (transcriptDayIndex < transcriptDates.length - 1) {
                transcriptDayIndex++;
                renderTranscriptListForDay();
            }
        });
        nextDayBtn.addEventListener('click', function() {
            if (transcriptDayIndex > 0) {
                transcriptDayIndex--;
                renderTranscriptListForDay();
            }
        });

        const audioWrap = document.getElementById('transcript-audio-wrap');
        const audioEl = document.getElementById('transcript-audio');
        const audioBack10 = document.getElementById('audio-back-10');
        const audioPlayPause = document.getElementById('audio-play-pause');
        const audioFwd10 = document.getElementById('audio-fwd-10');
        const audioTimeEl = document.getElementById('audio-time');

        function formatAudioTime(sec) {
            if (!isFinite(sec) || sec < 0) return '0:00';
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return m + ':' + (s < 10 ? '0' : '') + s;
        }
        function updateAudioTimeDisplay() {
            const cur = audioEl.currentTime;
            const dur = audioEl.duration;
            audioTimeEl.textContent = formatAudioTime(cur) + ' / ' + formatAudioTime(dur);
        }
        function updatePlayPauseLabel() {
            audioPlayPause.textContent = audioEl.paused ? 'â–¶ æ’­æ”¾' : 'â¸ æš«åœ';
        }
        (function initAudioControls() {
            audioEl.addEventListener('timeupdate', updateAudioTimeDisplay);
            audioEl.addEventListener('durationchange', updateAudioTimeDisplay);
            audioEl.addEventListener('play', updatePlayPauseLabel);
            audioEl.addEventListener('pause', updatePlayPauseLabel);
            audioBack10.addEventListener('click', function() {
                audioEl.currentTime = Math.max(0, audioEl.currentTime - 10);
                updateAudioTimeDisplay();
            });
            audioFwd10.addEventListener('click', function() {
                const d = audioEl.duration;
                if (isFinite(d)) audioEl.currentTime = Math.min(d, audioEl.currentTime + 10);
                else audioEl.currentTime += 10;
                updateAudioTimeDisplay();
            });
            audioPlayPause.addEventListener('click', function() {
                if (audioEl.paused) audioEl.play();
                else audioEl.pause();
            });
        })();

        async function viewTranscript(id) {
            const res = await fetch('/api/transcripts/' + id);
            const t = await res.json();
            detailTitle.textContent = t.episode_title || 'é€å­—ç¨¿';
            detailDate.textContent = t.created_at;
            detailBody.textContent = t.transcript_text || '';
            if (t.mp3_url) {
                audioWrap.style.display = 'block';
                audioEl.src = t.mp3_url;
                audioEl.load();
                audioTimeEl.textContent = '0:00 / 0:00';
                updatePlayPauseLabel();
            } else {
                audioWrap.style.display = 'none';
                audioEl.removeAttribute('src');
            }
            detailCard.style.display = 'block';
            hideFurigana();
            detailCard.scrollIntoView({ behavior: 'smooth' });
        }

        function hideFurigana() {
            if (furiganaAbort) { try { furiganaAbort.abort(); } catch (e) {} }
            furiganaAbort = null;
            currentWord = null;
            currentReading = null;
            currentContextText = '';
            currentContextOffset = 0;
            furiganaPop.style.display = 'none';
            furiganaPop.textContent = '';
            furiganaPop.removeAttribute('data-mode');
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        function isJapaneseChar(ch) {
            // Hiragana, Katakana, Kanji, prolonged sound mark, iteration marks
            return /[\u3040-\u30FF\u3400-\u9FFF\uF900-\uFAFF\u30FC\u3005]/.test(ch);
        }

        function hasKanji(s) {
            return /[\u3400-\u9FFF\uF900-\uFAFF]/.test(s || '');
        }

        function pickWordFromTextNode(text, offset) {
            if (!text) return '';
            const i = Math.min(Math.max(offset, 0), Math.max(text.length - 1, 0));

            // 1) å„ªå…ˆç”¨ç€è¦½å™¨çš„æ—¥æ–‡æ–·è©ï¼ˆæ›´ç²¾ç¢ºï¼Œä¸æœƒä¸€æ¬¡æŠ“ä¸€å¤§ä¸²ï¼‰
            try {
                if (typeof Intl !== 'undefined' && Intl.Segmenter) {
                    const seg = new Intl.Segmenter('ja', { granularity: 'word' });
                    for (const part of seg.segment(text)) {
                        const start = part.index;
                        const end = start + part.segment.length;
                        if (i >= start && i < end) {
                            const w = (part.segment || '').trim();
                            if (!w) return '';
                            if (!hasKanji(w)) return ''; // åªå°ã€Œå«æ¼¢å­—çš„è©ã€é¡¯ç¤ºè®€éŸ³
                            return w.length > 24 ? w.slice(0, 24) : w;
                        }
                    }
                }
            } catch (e) {
                // ignore and fallback
            }

            // 2) fallbackï¼šç°¡æ˜“è¦å‰‡ï¼ˆé¿å…ä¸€æ¬¡æŠ“åˆ°æ•´å¥ï¼‰
            let j = i;
            if (j > 0 && !isJapaneseChar(text[j]) && isJapaneseChar(text[j - 1])) j = j - 1;
            if (!isJapaneseChar(text[j])) return '';
            let l = j, r = j;
            // å¥è®€é»/ç©ºç™½/æ‹¬è™Ÿç­‰ç›´æ¥æˆªæ–·
            const stopRe = /[\s\u3000ã€ã€‚ï¼ï¼Œ,\.\(\)\[\]ã€Œã€ã€ã€ã€ã€‘ï¼œï¼<>]/;
            while (l > 0 && isJapaneseChar(text[l - 1]) && !stopRe.test(text[l - 1])) l--;
            while (r < text.length && isJapaneseChar(text[r]) && !stopRe.test(text[r])) r++;
            let w = text.slice(l, r).trim();
            // å†é™ç¸®ï¼šåªä¿ç•™å‰å¾Œæœ€å¤š 16 å­—ï¼Œé¿å…è¶…é•·é€£çºŒå­—ä¸²
            if (w.length > 16) w = w.slice(0, 16);
            if (!hasKanji(w)) return '';
            return w;
        }

        function caretRangeFromPoint(x, y) {
            if (document.caretRangeFromPoint) return document.caretRangeFromPoint(x, y);
            if (document.caretPositionFromPoint) {
                const pos = document.caretPositionFromPoint(x, y);
                if (!pos) return null;
                const range = document.createRange();
                range.setStart(pos.offsetNode, pos.offset);
                range.setEnd(pos.offsetNode, pos.offset);
                return range;
            }
            return null;
        }

        function furiganaFirstLineHtml(word, reading, isPlaceholder) {
            const r = reading != null ? reading : (isPlaceholder ? 'â€¦' : 'ç„¡');
            const extendBtn = (currentContextText !== '' && currentContextText.length > currentContextOffset + 1)
                ? ` <button type="button" class="furigana-extend-btn" title="è©¦è©¦è¼ƒé•·ç¯„åœ">&gt;</button>`
                : '';
            return `<span class="w">${escapeHtml(word)}</span> <span class="r">(${escapeHtml(r)})</span>${extendBtn}`;
        }

        async function showFuriganaAt(x, y, word, contextText, contextOffset) {
            if (!word) return;
            hideFurigana();
            currentWord = word;
            currentContextText = typeof contextText === 'string' ? contextText : '';
            currentContextOffset = typeof contextOffset === 'number' ? contextOffset : 0;
            furiganaPop.style.left = Math.min(x + 12, window.innerWidth - 30) + 'px';
            furiganaPop.style.top = Math.min(y + 8, window.innerHeight - 30) + 'px';
            furiganaPop.style.display = 'block';
            furiganaPop.innerHTML = furiganaFirstLineHtml(word, null, true);

            furiganaAbort = new AbortController();
            try {
                const res = await fetch('/api/furigana?text=' + encodeURIComponent(word), { signal: furiganaAbort.signal });
                const data = await res.json();
                if (!data || !data.ok) {
                    furiganaPop.innerHTML = furiganaFirstLineHtml(word, 'æŸ¥è©¢å¤±æ•—', false);
                    return;
                }
                currentReading = (data.reading || '').trim() || 'ç„¡';
                furiganaPop.innerHTML = furiganaFirstLineHtml(word, currentReading, false);
            } catch (e) {
                if (e.name === 'AbortError') return;
                furiganaPop.innerHTML = furiganaFirstLineHtml(word, 'æŸ¥è©¢å¤±æ•—', false);
            }
        }

        async function extendFuriganaRange() {
            if (!currentContextText || currentContextOffset < 0) return;
            const text = currentContextText;
            const offset = currentContextOffset;
            const stopRe = /[\s\u3000ã€ã€‚ï¼ï¼Œ,\.\(\)\[\]ã€Œã€ã€ã€ã€ã€‘ï¼œï¼<>]/;
            const maxLen = 10;
            const candidates = [];
            for (let len = 2; len <= maxLen && offset + len <= text.length; len++) {
                const sub = text.slice(offset, offset + len);
                if (stopRe.test(sub)) break;
                if (sub.length > (currentWord || '').length) candidates.push(sub);
            }
            if (candidates.length === 0) return;
            const container = document.getElementById('furigana-extend-results') || (function() {
                const el = document.createElement('div');
                el.id = 'furigana-extend-results';
                el.className = 'furigana-extend-results';
                furiganaPop.appendChild(el);
                return el;
            }());
            container.innerHTML = '<span style="color:#888;">è¼ƒé•·ç¯„åœï¼š</span>';
            for (const sub of candidates) {
                try {
                    const res = await fetch('/api/furigana?text=' + encodeURIComponent(sub));
                    const data = await res.json();
                    if (data && data.ok && data.reading) {
                        const reading = (data.reading || '').trim();
                        if (reading !== (currentReading || '')) {
                            const item = document.createElement('div');
                            item.className = 'item';
                            item.setAttribute('data-word', sub);
                            item.setAttribute('data-reading', reading);
                            item.textContent = sub + ' (' + reading + ')';
                            item.title = 'é»æ“Šå¯æ–°å¢æ­¤è©åˆ° rasword';
                            container.appendChild(item);
                        }
                    }
                } catch (e) { /* skip */ }
            }
        }

        function showConfirmAddToRasword() {
            const reading = currentReading || 'â€¦';
            furiganaPop.setAttribute('data-mode', 'confirm');
            furiganaPop.innerHTML = `
                <div>
                    <div class="w">${escapeHtml(currentWord)}</div>
                    <div class="r">(${escapeHtml(reading)})</div>
                    <div style="margin-top:4px;font-size:0.85rem;color:#ccc;">è¦æ–°å¢åˆ° rasword å–®å­—åº«å—ï¼Ÿ</div>
                    <div style="margin-top:6px;display:flex;gap:8px;">
                        <button type="button" data-choice="y" style="padding:4px 10px;border-radius:6px;border:none;background:#22c55e;color:#fff;cursor:pointer;">y</button>
                        <button type="button" data-choice="n" style="padding:4px 10px;border-radius:6px;border:none;background:#6b7280;color:#fff;cursor:pointer;">n</button>
                    </div>
                    <div id="furigana-add-status" style="margin-top:6px;font-size:0.8rem;"></div>
                </div>
            `;
        }

        async function addCurrentWordToRasword() {
            const addAreaId = 'furigana-add-status';
            let statusEl = document.getElementById(addAreaId);
            if (!currentWord) return;
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = addAreaId;
                statusEl.style.marginTop = '6px';
                statusEl.style.fontSize = '0.8rem';
                furiganaPop.appendChild(statusEl);
            }
            statusEl.textContent = 'rasword æ–°å¢ä¸­â€¦';
            try {
                const res = await fetch('/api/rasword/add-word', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word: currentWord })
                });
                const data = await res.json();
                if (!res.ok || !data.ok) {
                    statusEl.textContent = 'âŒ æ–°å¢å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤');
                    return;
                }
                const w = data.word || {};
                const brief = (w.chinese_short || '').trim() || (w.chinese_meaning || '').slice(0, 18);
                if (data.exists) {
                    statusEl.textContent = 'âœ… å·²åœ¨ raswordï¼š' + (brief || 'å·²å­˜åœ¨å–®å­—');
                } else {
                    statusEl.textContent = 'âœ… å·²æ–°å¢åˆ° raswordï¼š' + (brief || 'å·²å»ºç«‹å–®å­—');
                }
            } catch (e) {
                statusEl.textContent = 'âŒ æ–°å¢å¤±æ•—ï¼š' + e.message;
            }
        }

        // é»æ“Šé€å­—ç¨¿æ–‡å­—ï¼šé¡¯ç¤º (æŒ¯å‡å)
        detailBody.addEventListener('click', (ev) => {
            const range = caretRangeFromPoint(ev.clientX, ev.clientY);
            if (!range) return;
            const node = range.startContainer;
            if (!node || node.nodeType !== Node.TEXT_NODE) return;
            const word = pickWordFromTextNode(node.textContent || '', range.startOffset);
            if (!word) return;
            showFuriganaAt(ev.clientX, ev.clientY, word, node.textContent || '', range.startOffset);
        });

        // é»æ“Šå‡åå°è¦–çª—ï¼šè©¢å•æ˜¯å¦æ–°å¢åˆ° raswordï¼›ã€Œ>ã€å‰‡è¼ƒé•·ç¯„åœï¼›è¼ƒé•·ç¯„åœè©å¯é»æ“Šæ–°å¢
        furiganaPop.addEventListener('click', (ev) => {
            ev.stopPropagation();
            if (ev.target.closest('.furigana-extend-btn')) {
                extendFuriganaRange();
                return;
            }
            const extendItem = ev.target.closest('.furigana-extend-results .item');
            if (extendItem && extendItem.dataset.word) {
                currentWord = extendItem.dataset.word;
                currentReading = (extendItem.dataset.reading || '').trim() || 'â€¦';
                showConfirmAddToRasword();
                return;
            }
            if (!currentWord) return;
            const mode = furiganaPop.getAttribute('data-mode') || 'reading';
            if (mode === 'reading') {
                showConfirmAddToRasword();
                return;
            }
            const target = ev.target;
            if (target && target.dataset && target.dataset.choice) {
                const choice = target.dataset.choice;
                if (choice === 'y') {
                    addCurrentWordToRasword();
                } else if (choice === 'n') {
                    hideFurigana();
                }
            }
        });

        // é»å…¶ä»–åœ°æ–¹å°±é—œæ‰
        document.addEventListener('click', (ev) => {
            if (ev.target === detailBody || detailBody.contains(ev.target)) return;
            if (ev.target === furiganaPop || furiganaPop.contains(ev.target)) return;
            hideFurigana();
        });

        async function deleteFeed(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚é–±ï¼Ÿ')) return;
            await fetch('/api/feeds/' + id, { method: 'DELETE' });
            loadFeeds();
            loadTranscripts();
        }

        async function runNow(id) {
            await fetch('/api/run-now/' + id, { method: 'POST' });
            showAddMsg('å·²æ’å…¥åŸ·è¡Œï¼Œè«‹ç¨å€™é‡æ–°æ•´ç†é€å­—ç¨¿åˆ—è¡¨ã€‚', 'info');
            setTimeout(loadTranscripts, 15000);
        }

        document.getElementById('add-feed-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rss_url = document.getElementById('rss_url').value.trim();
            const schedule = document.getElementById('schedule').value;
            const res = await fetch('/api/feeds', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rss_url, schedule })
            });
            const data = await res.json();
            if (res.ok && data.success) {
                showAddMsg('å·²æ–°å¢è¨‚é–±ã€‚ç³»çµ±æœƒä¾é€±æœŸå°‡æœ€æ–° MP3 é€£çµå‚³çµ¦ AI API ç”¢ç”Ÿæ—¥æ–‡é€å­—ç¨¿ã€‚', 'success');
                document.getElementById('rss_url').value = '';
                loadFeeds();
            } else {
                showAddMsg(data.error || 'æ–°å¢å¤±æ•—', 'error');
            }
        });

        filterFeed.addEventListener('change', loadTranscripts);

        document.addEventListener('DOMContentLoaded', () => {
            setApiProviderUI();
            loadApiSettings();
            loadFeeds();
            loadTranscripts();
        });
    </script>
</body>
</html>
